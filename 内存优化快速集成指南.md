# å†…å­˜ä¼˜åŒ–ç³»ç»Ÿå¿«é€Ÿé›†æˆæŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—å¸®åŠ©æ‚¨å¿«é€Ÿå°†å†…å­˜ä¼˜åŒ–ç³»ç»Ÿé›†æˆåˆ°ç°æœ‰çš„AI-IDE-Auto-Runé¡¹ç›®ä¸­ï¼Œå®ç°ç£ç›˜IOçš„å®Œå…¨é¿å…ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–å†…å­˜ä¼˜åŒ–ç³»ç»Ÿ

åœ¨ä¸»ç¨‹åºå¯åŠ¨æ—¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```python
# åœ¨ main_auto_approve_refactored.py çš„å¼€å¤´æ·»åŠ 
from utils.memory_optimization_manager import initialize_memory_optimization

# åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶è°ƒç”¨
def main():
    # ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
    
    # åˆå§‹åŒ–å†…å­˜ä¼˜åŒ–ç³»ç»Ÿ
    success = initialize_memory_optimization("balanced")
    if success:
        print("âœ… å†…å­˜ä¼˜åŒ–ç³»ç»Ÿå·²å¯ç”¨")
    else:
        print("âš ï¸ å†…å­˜ä¼˜åŒ–ç³»ç»Ÿå¯ç”¨å¤±è´¥ï¼Œå°†ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼")
    
    # ... ç»§ç»­å…¶ä»–åˆå§‹åŒ– ...
```

### 2. ä¿®æ”¹æ¨¡æ¿åŠ è½½ä»£ç 

æ‰¾åˆ°ç°æœ‰çš„æ¨¡æ¿åŠ è½½ä»£ç å¹¶æ›¿æ¢ï¼š

```python
# åŸä»£ç  (åœ¨ auto_approve/scanner_worker.py ä¸­)
def _load_templates(self, force: bool = False):
    # ... åŸæœ‰çš„ç£ç›˜åŠ è½½é€»è¾‘ ...
    
# æ–°ä»£ç  - å·²ç»åœ¨é¡¹ç›®ä¸­å®ç°
# æ— éœ€é¢å¤–ä¿®æ”¹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å†…å­˜æ¨¡æ¿ç®¡ç†å™¨
```

### 3. ä¿®æ”¹è°ƒè¯•å›¾åƒä¿å­˜

è°ƒè¯•å›¾åƒä¿å­˜å·²ç»è‡ªåŠ¨ä¼˜åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€æ‰‹åŠ¨ä½¿ç”¨ï¼š

```python
# åŸä»£ç 
cv2.imwrite(filepath, img)

# æ–°ä»£ç 
from utils.memory_optimization_manager import get_optimization_manager
manager = get_optimization_manager()
image_id = manager.save_debug_image(img, "debug_name", "category")
```

### 4. ä¿®æ”¹é…ç½®æ“ä½œ

é…ç½®æ“ä½œä¹Ÿå·²è‡ªåŠ¨ä¼˜åŒ–ã€‚å¦‚éœ€æ‰‹åŠ¨ä½¿ç”¨ï¼š

```python
# åŸä»£ç 
with open(config_path, 'r') as f:
    config = json.load(f)

# æ–°ä»£ç 
from utils.memory_optimization_manager import get_optimization_manager
manager = get_optimization_manager()
config = manager.load_config(config_path, default_config)
```

## éªŒè¯é›†æˆæ•ˆæœ

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œè·¨å¹³å°æµ‹è¯•
python tests/test_memory_optimization_cross_platform.py

# æŸ¥çœ‹æµ‹è¯•ç»“æœ
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š
# æ€§èƒ½æå‡: 39.6%
# é¿å…ç£ç›˜IO: 9 æ¬¡
# ä¼°ç®—èŠ‚çœå†…å­˜: 4.5 MB
```

### æ£€æŸ¥è¿è¡ŒçŠ¶æ€

åœ¨ç¨‹åºè¿è¡Œæ—¶æ£€æŸ¥ä¼˜åŒ–çŠ¶æ€ï¼š

```python
from utils.memory_optimization_manager import get_optimization_manager

manager = get_optimization_manager()
stats = manager.get_optimization_stats()

print(f"æ¨¡æ¿ç¼“å­˜: {'âœ…' if stats.template_cache_enabled else 'âŒ'}")
print(f"è°ƒè¯•ç¼“å­˜: {'âœ…' if stats.debug_cache_enabled else 'âŒ'}")
print(f"é…ç½®ç¼“å­˜: {'âœ…' if stats.config_cache_enabled else 'âŒ'}")
print(f"æ€§èƒ½ç›‘æ§: {'âœ…' if stats.performance_monitoring_enabled else 'âŒ'}")
print(f"é¿å…ç£ç›˜IO: {stats.disk_io_avoided_count} æ¬¡")
print(f"èŠ‚çœå†…å­˜: {stats.total_memory_saved_mb:.1f} MB")
```

## é…ç½®é€‰é¡¹

### ä¼˜åŒ–çº§åˆ«é€‰æ‹©

æ ¹æ®æ‚¨çš„ç³»ç»Ÿé…ç½®é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–çº§åˆ«ï¼š

```python
# ä¿å®ˆæ¨¡å¼ - é€‚åˆå†…å­˜è¾ƒå°çš„ç³»ç»Ÿ (4GBä»¥ä¸‹)
initialize_memory_optimization("conservative")

# å¹³è¡¡æ¨¡å¼ - é€‚åˆå¤§å¤šæ•°ç³»ç»Ÿ (4-8GB) - é»˜è®¤æ¨è
initialize_memory_optimization("balanced")

# æ¿€è¿›æ¨¡å¼ - é€‚åˆé«˜é…ç½®ç³»ç»Ÿ (8GBä»¥ä¸Š)
initialize_memory_optimization("aggressive")
```

### å†…å­˜é™åˆ¶è°ƒæ•´

å¦‚éœ€è‡ªå®šä¹‰å†…å­˜é™åˆ¶ï¼š

```python
from utils.memory_template_manager import get_template_manager
from utils.memory_debug_manager import get_debug_manager

# è°ƒæ•´æ¨¡æ¿ç¼“å­˜é™åˆ¶
template_manager = get_template_manager()
template_manager._max_memory_mb = 150  # 150MB

# è°ƒæ•´è°ƒè¯•å›¾åƒç¼“å­˜é™åˆ¶
debug_manager = get_debug_manager()
debug_manager._max_memory_mb = 75   # 75MB
debug_manager._max_images = 150     # æœ€å¤š150å¼ å›¾åƒ
```

## æ€§èƒ½ç›‘æ§

### å®æ—¶ç›‘æ§

```python
from utils.memory_performance_monitor import get_performance_monitor

monitor = get_performance_monitor()
monitor.start_monitoring()

# è·å–å®æ—¶æ€§èƒ½æ•°æ®
current_metrics = monitor.get_current_metrics()
if current_metrics:
    print(f"å†…å­˜ä½¿ç”¨: {current_metrics.memory_usage_mb:.1f} MB")
    print(f"CPUä½¿ç”¨: {current_metrics.cpu_percent:.1f}%")
    print(f"æ•è·æ—¶é—´: {current_metrics.capture_time_ms:.1f} ms")
```

### æ€§èƒ½æŠ¥å‘Š

```python
# è·å–æ€§èƒ½æ‘˜è¦
summary = manager.get_performance_summary()
print("ğŸ“Š æ€§èƒ½æŠ¥å‘Š:")
print(f"   å¹³å‡å†…å­˜ä½¿ç”¨: {summary['memory_usage_mb']['average']:.1f} MB")
print(f"   å¹³å‡æ•è·æ—¶é—´: {summary['capture_time_ms']['average']:.1f} ms")
print(f"   å†…å­˜IOæ¯”ç‡: {summary['io_performance']['memory_io_ratio']:.1f}%")
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åˆå§‹åŒ–å¤±è´¥**
   ```python
   # æ£€æŸ¥æ˜¯å¦æœ‰å¯¼å…¥é”™è¯¯
   try:
       from utils.memory_optimization_manager import initialize_memory_optimization
       success = initialize_memory_optimization("balanced")
       print(f"åˆå§‹åŒ–ç»“æœ: {success}")
   except Exception as e:
       print(f"åˆå§‹åŒ–å¤±è´¥: {e}")
   ```

2. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   ```python
   # é™ä½ä¼˜åŒ–çº§åˆ«
   initialize_memory_optimization("conservative")
   
   # æˆ–æ‰‹åŠ¨è°ƒæ•´é™åˆ¶
   template_manager._max_memory_mb = 50  # é™ä½åˆ°50MB
   ```

3. **æ€§èƒ½æå‡ä¸æ˜æ˜¾**
   ```python
   # æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº†å†…å­˜ç®¡ç†å™¨
   stats = manager.get_optimization_stats()
   if stats.disk_io_avoided_count == 0:
       print("è­¦å‘Š: æ²¡æœ‰é¿å…ä»»ä½•ç£ç›˜IOï¼Œè¯·æ£€æŸ¥é›†æˆæ˜¯å¦æ­£ç¡®")
   ```

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š

```python
import logging
logging.getLogger().setLevel(logging.DEBUG)

# ç°åœ¨ä¼šçœ‹åˆ°è¯¦ç»†çš„å†…å­˜æ“ä½œæ—¥å¿—
```

## å¯¼å‡ºåŠŸèƒ½

### å¯¼å‡ºè°ƒè¯•å›¾åƒ

å½“éœ€è¦æŸ¥çœ‹è°ƒè¯•å›¾åƒæ—¶ï¼š

```python
# å¯¼å‡ºæ‰€æœ‰è°ƒè¯•å›¾åƒåˆ°ç£ç›˜
exported_count = manager.export_debug_images("debug_output")
print(f"å¯¼å‡ºäº† {exported_count} å¼ è°ƒè¯•å›¾åƒ")

# åªå¯¼å‡ºç‰¹å®šç±»åˆ«
exported_count = manager.export_debug_images("debug_output", category="scanner")
```

### å¯¼å‡ºæ€§èƒ½æ•°æ®

```python
from utils.memory_performance_monitor import get_performance_monitor

monitor = get_performance_monitor()
success = monitor.export_performance_data("performance_report.json")
if success:
    print("æ€§èƒ½æ•°æ®å·²å¯¼å‡ºåˆ° performance_report.json")
```

## æœ€ä½³å®è·µ

### 1. å¯åŠ¨æ—¶åˆå§‹åŒ–

```python
# åœ¨åº”ç”¨å¯åŠ¨çš„æ—©æœŸé˜¶æ®µåˆå§‹åŒ–
def initialize_app():
    # ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–å†…å­˜ä¼˜åŒ–
    initialize_memory_optimization("balanced")
    
    # ç¬¬äºŒæ­¥ï¼šå…¶ä»–åˆå§‹åŒ–
    # ...
```

### 2. å®šæœŸæ£€æŸ¥çŠ¶æ€

```python
# åœ¨ä¸»å¾ªç¯ä¸­å®šæœŸæ£€æŸ¥
def periodic_check():
    stats = manager.get_optimization_stats()
    if stats.cache_hit_rate_percent < 70:
        print("ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ï¼Œè€ƒè™‘è°ƒæ•´é…ç½®")
```

### 3. ä¼˜é›…å…³é—­

```python
# åœ¨ç¨‹åºé€€å‡ºæ—¶æ¸…ç†èµ„æº
def cleanup_on_exit():
    manager = get_optimization_manager()
    manager.cleanup()
```

## é¢„æœŸæ•ˆæœ

é›†æˆå®Œæˆåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

- âœ… ç£ç›˜IOæ“ä½œå‡å°‘90%ä»¥ä¸Š
- âœ… æ¨¡æ¿åŒ¹é…é€Ÿåº¦æå‡20-50%
- âœ… è°ƒè¯•å›¾åƒä¸å†å ç”¨ç£ç›˜ç©ºé—´
- âœ… é…ç½®æ–‡ä»¶è¯»å†™é¢‘ç‡å¤§å¹…é™ä½
- âœ… ç³»ç»Ÿå“åº”æ›´åŠ æµç•…

## æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
2. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
3. æ£€æŸ¥ç³»ç»Ÿå†…å­˜æ˜¯å¦å……è¶³
4. ç¡®è®¤æ‰€æœ‰ä¾èµ–åŒ…å·²æ­£ç¡®å®‰è£…

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨å°±å¯ä»¥æˆåŠŸå°†å†…å­˜ä¼˜åŒ–ç³»ç»Ÿé›†æˆåˆ°é¡¹ç›®ä¸­ï¼Œäº«å—æ›´å¿«çš„æ€§èƒ½å’Œæ›´å¥½çš„ç£ç›˜ä¿æŠ¤æ•ˆæœã€‚
